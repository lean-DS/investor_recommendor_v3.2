substitutions:
  _REGION: "europe-west1"
  _REPO: "portfolio-repo"
  _IMAGE: "portfolio-app"
  _SERVICE: "portfolio"
  _PROJECT: "fintech-inv-recomm"

steps:
  # Seed cache (ignore if not found)
  - name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args:
      - -lc
      - |
        docker pull ${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/${_IMAGE}:latest || true

  # Build (use cache + ensure fresh base)
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "build",
        "--pull",
        "--cache-from",
        "${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/${_IMAGE}:latest",
        "--build-arg","CACHE_BUST=$SHORT_SHA",
        "-t","${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/${_IMAGE}:$SHORT_SHA",
        "-t","${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/${_IMAGE}:latest",
        ".",
      ]

  # Push both tags
  - name: "gcr.io/cloud-builders/docker"
    args: ["push","${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/${_IMAGE}:$SHORT_SHA"]
  - name: "gcr.io/cloud-builders/docker"
    args: ["push","${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/${_IMAGE}:latest"]

  # Deploy with unique revision & retry on conflict
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: bash
    args:
      - -lc
      - |
        set -e
        for i in 1 2 3; do
          gcloud run deploy "${_SERVICE}" \
            --image "${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/${_IMAGE}:$SHORT_SHA" \
            --region "${_REGION}" \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --memory 512Mi \
            --cpu 1 \
            --concurrency 80 \
            --revision-suffix "$SHORT_SHA" \
            --quiet && break
          echo "Deploy conflict, retrying in 6s (attempt $i/3)â€¦"
          sleep 6
        done

images:
  - "${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/${_IMAGE}:$SHORT_SHA"
  - "${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/${_IMAGE}:latest"

options:
  logging: CLOUD_LOGGING_ONLY
